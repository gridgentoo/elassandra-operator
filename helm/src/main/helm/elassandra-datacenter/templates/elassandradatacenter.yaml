apiVersion: elassandra.strapdata.com/v1beta1
kind: ElassandraDatacenter
metadata:
  name: {{ template "elassandra.resourceName" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    app: "elassandra"
    app.kubernetes.io/managed-by: "elassandra-operator"
    elassandra.strapdata.com/cluster: {{ include "elassandra.clusterName" . }}
    elassandra.strapdata.com/datacenter: {{ include "elassandra.datacenterName" . }}
    chart: {{ template "elassandra.chart" . }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
{{- if .Values.labels }}
{{ toYaml .Values.labels | indent 4 }}
{{- end }}
spec:
  clusterName: {{ include "elassandra.clusterName" . | required "Invalid clusterName : Release name has to be clustername-dcname (in lowercase), clustername must match ([0-9a-z]+)" }}
  datacenterName: {{ include "elassandra.datacenterName" . | required "Invalid datacenterName : Release name has to be clustername-dcname (in lowercase), datacenterName must match ([0-9a-z]+)" }}
  replicas: {{ default "1" .Values.replicas }}
  parked: {{ default false .Values.parked }}
  autoScaleMode: {{ default "MANUAL" .Values.autoScaleMode | quote }}
  nodeAffinityPolicy: {{ default "STRICT" .Values.nodeAffinityPolicy | quote }}
  maxPodUnavailable: {{ default 1 .Values.maxPodUnavailable }}
  {{- if .Values.webHookUrl }}
  webHookUrl: {{ .Values.webHookUrl }}
  {{- end }}
  elassandraImage: "{{ .Values.image.elassandraRepository }}:{{ .Values.image.tag }}"
  {{- if .Values.serviceAccount }}
  serviceAccount: {{ .Values.serviceAccount  }}
  {{ else }}
  serviceAccount: {{ template "elassandra.serviceAccount" . }}
  {{- end }}
  {{- if .Values.podTemplate }}
  podTemplate:
{{ toYaml .Values.podTemplate | indent 4 }}
  {{- end }}
  dataVolumeClaim:
{{ toYaml .Values.dataVolumeClaim | indent 4 }}
  {{- if .Values.env }}
  env:
{{ toYaml .Values.env | indent 4 }}
  {{- end }}
  {{- if .Values.scheduledBackups }}
  scheduledBackups:
{{ toYaml .Values.scheduledBackups | indent 4 }}
  {{- end }}
  userConfigMapVolumeSource:
    name: {{ template "elassandra.resourceName" . }}
    items:
{{- range $key, $val := .Values.configs }}
      - key: {{ $key }}
        path: {{ $key }}
{{- end }}
{{- if .Values.userConfigMapVolumeSource }}
{{ toYaml .Values.userConfigMapVolumeSource | indent 4 }}
{{- end }}
{{- if .Values.userSecretVolumeSource }}
  userSecretVolumeSource:
{{ toYaml .Values.userSecretVolumeSource | indent 4 }}
{{- end }}
{{- if .Values.elasticsearch }}
  elasticsearch:
    enabled: {{ .Values.elasticsearch.enabled }}
    httpPort: {{ default 9200 .Values.elasticsearch.httpPort }}
    transportPort: {{ default 9300 .Values.elasticsearch.transportPort }}
    loadBalancerEnabled: {{ default false .Values.elasticsearch.loadBalancerEnabled }}
    {{- if .Values.elasticsearch.loadBalancerIp }}
    loadBalancerIp: {{ .Values.elasticsearch.loadBalancerIp | quote }}
    {{- end }}
    ingressEnabled: {{ default false .Values.elasticsearch.ingressEnabled }}
    {{- if .Values.elasticsearch.datacenterGroup }}
    datacenterGroup: {{ .Values.elasticsearch.datacenterGroup | quote }}
    {{- end }}
    {{- if .Values.elasticsearch.datacenterTags }}
    datacenterTags: {{ .Values.elasticsearch.datacenterTags }}
    {{- end }}
    {{- if .Values.elasticsearch.enterprise }}
    enterprise:
{{ toYaml .Values.elasticsearch.enterprise | indent 6 }}
    {{- end }}
{{- end }}
{{- if .Values.kibana }}
  kibana:
    enabled: {{ .Values.kibana.enabled }}
    {{- if .Values.kibana.image }}
    {{- if .Values.kibana.tag }}
    image:  "{{ .Values.kibana.image }}:{{ .Values.kibana.tag }}"
    {{- else }}
    image:  "{{ .Values.kibana.image }}:{{ template "kibana.version" . }}"
    {{- end }}
    {{- end }}
    {{- if .Values.kibana.spaces }}
    spaces:
{{ toYaml .Values.kibana.spaces | indent 6 }}
    {{- end }}
{{- end }}
  prometheus:
    enabled: {{ default false .Values.prometheus.enabled }}
    port: {{ default 9500 .Values.prometheus.port }}
{{- if .Values.reaper }}
  reaper:
    enabled: {{ default false .Values.reaper.enabled }}
    {{- if .Values.reaper.image }}
    image: {{ .Values.reaper.image }}
    {{- end }}
    {{- if .Values.reaper.ingressHost }}
    ingressHost: {{ .Values.reaper.ingressHost }}
    {{- end }}
    {{- if .Values.reaper.ingressAdminHost }}
    ingressAdminHost: {{ .Values.reaper.ingressAdminHost }}
    {{- end }}
    {{- if .Values.reaper.ingressAnnotations }}
    ingressAnnotations:
{{ toYaml .Values.reaper.ingressAnnotations | indent 6 }}
    {{- end }}
    jwtSecret: {{ default "68d45d8f-419f-429e-8ba0-7b475cba795d" .Values.reaper.jwtSecret }}
    loggingLevel: {{ default "INFO" .Values.reaper.loggingLevel }}
    {{- if .Values.reaper.podTemplate }}
    podTemplate:
    {{ toYaml .Values.reaper.podTemplate | indent 6 }}
    {{- end }}
{{- end }}
  networking:
    hostPortEnabled: {{ default false .Values.networking.hostPortEnabled }}
    hostNetworkEnabled: {{ default false .Values.networking.hostNetworkEnabled }}
    externalDns:
      enabled: {{ default false .Values.networking.externalDns.enabled }}
      root: {{ default "xxx" .Values.networking.externalDns.root | quote }}
      domain: {{ .Values.networking.externalDns.domain | quote }}
      ttl: {{ default "300" .Values.networking.externalDns.ttl }}
  jvm:
    computeJvmMemorySettings: {{ default true .Values.jvm.computeJvmMemorySettings }}
    jdbPort: {{ default -1 .Values.jvm.jdbPort }}
    jmxPort: {{ default -1 .Values.jvm.jmxPort }}
    jmxmpEnabled: {{ default true .Values.jvm.jmxmpEnabled }}
    jmxmpOverSSL: {{ default true .Values.jvm.jmxmpOverSSL  }}
  cassandra:
    workload: {{ default "READ_WRITE" .Values.workload  | quote }}
    commitlogsInitContainer: {{ default false .Values.cassandra.commitlogsInitContainer }}
    nativePort: {{ default 9042 .Values.cassandra.nativePort }}
    storagePort: {{ default 7000 .Values.cassandra.storagePort }}
    sslStoragePort: {{ default 7001 .Values.cassandra.sslStoragePort }}
    {{- if .Values.cassandra.ssl }}
    ssl:
    {{ toYaml .Values.cassandra.ssl | indent 6 }}
    {{- end }}
    {{- if .Values.cassandra.authentication }}
    authentication:
    {{ toYaml .Values.cassandra.authentication | indent 6 }}
    {{- end }}
    {{- if .Values.cassandra.remoteSeeds }}
    remoteSeeds:
    {{ toYaml .Values.cassandra.remoteSeeds | indent 6 }}
    {{- end }}
    {{- if .Values.cassandra.remoteSeeders }}
    remoteSeeders:
    {{ toYaml .Values.cassandra.remoteSeeders | indent 6 }}
    {{- end }}
    snitchPreferLocal: {{ default true .Values.cassandra.snitchPreferLocal }}
{{- if .Values.managedKeyspaces }}
  managedKeyspaces:
{{ toYaml .Values.managedKeyspaces | indent 4 }}
{{- end }}

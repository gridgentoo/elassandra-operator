

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Security &mdash; Elassandra Operator Documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="https://media.readthedocs.org/css/sphinx_rtd_theme.css" type="text/css" />
  <link rel="stylesheet" href="https://media.readthedocs.org/css/readthedocs-doc-embed.css" type="text/css" />
  <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script src="_static/custom.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Operations" href="operations.html" />
    <link rel="prev" title="Advanced services" href="advanced-services.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> Elassandra-Operator
          

          
            
            <img src="_static/elassandra-operator.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="helm-setup.html">HELM setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="operator-setup.html">Operator setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="provisioning.html">Provision a Datacenter</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced-services.html">Advanced services</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Security</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#kubernetes-rbac">Kubernetes RBAC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#certificate-management">Certificate management</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#datacenter-ca">Datacenter CA</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generated-certificates">Generated Certificates</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#elassandra-credentials">Elassandra Credentials</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="operations.html">Operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="compute-resources.html">Compute resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="full-setup.html">Full Setup Example</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Elassandra-Operator</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Security</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/security.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="security">
<h1>Security<a class="headerlink" href="#security" title="Permalink to this headline">¶</a></h1>
<div class="section" id="kubernetes-rbac">
<h2>Kubernetes RBAC<a class="headerlink" href="#kubernetes-rbac" title="Permalink to this headline">¶</a></h2>
<p>When Kubernetes <code class="docutils literal notranslate"><span class="pre">hostNetwork</span></code> or <code class="docutils literal notranslate"><span class="pre">hostPort</span></code> is enabled (see Networking), the Elassandra operator adds an init container
named <strong>nodeinfo</strong> allowing the Elassandra pods to get the node public IP address.</p>
<p>In order to access Kubernetes these nodes information, the Elassandra Operator HELM chart creates a dedicated ServiceAccount
suffixed by <code class="docutils literal notranslate"><span class="pre">nodeinfo</span></code> associated to the ClusterRole <code class="docutils literal notranslate"><span class="pre">node-reader</span></code> with the following permissions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">rbac</span><span class="o">.</span><span class="n">authorization</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ClusterRole</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="p">{{</span> <span class="n">template</span> <span class="s2">&quot;elassandra-operator.name&quot;</span> <span class="o">.</span> <span class="p">}}</span>
    <span class="n">chart</span><span class="p">:</span> <span class="p">{{</span> <span class="o">.</span><span class="n">Chart</span><span class="o">.</span><span class="n">Name</span> <span class="p">}}</span><span class="o">-</span><span class="p">{{</span> <span class="o">.</span><span class="n">Chart</span><span class="o">.</span><span class="n">Version</span> <span class="p">}}</span>
    <span class="n">heritage</span><span class="p">:</span> <span class="p">{{</span> <span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Service</span> <span class="p">}}</span>
    <span class="n">release</span><span class="p">:</span> <span class="p">{{</span> <span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span> <span class="p">}}</span>
  <span class="n">name</span><span class="p">:</span> <span class="p">{{</span> <span class="n">template</span> <span class="s2">&quot;elassandra-operator.fullname&quot;</span> <span class="o">.</span> <span class="p">}}</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="n">reader</span>
<span class="n">rules</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">apiGroups</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>
    <span class="n">resources</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">]</span>
    <span class="n">verbs</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="s2">&quot;list&quot;</span><span class="p">,</span> <span class="s2">&quot;watch&quot;</span><span class="p">]</span>
  <span class="o">-</span> <span class="n">apiGroups</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>
    <span class="n">resources</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pods&quot;</span><span class="p">]</span>
    <span class="n">verbs</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="s2">&quot;list&quot;</span><span class="p">,</span> <span class="s2">&quot;watch&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="certificate-management">
<h2>Certificate management<a class="headerlink" href="#certificate-management" title="Permalink to this headline">¶</a></h2>
<div class="section" id="datacenter-ca">
<h3>Datacenter CA<a class="headerlink" href="#datacenter-ca" title="Permalink to this headline">¶</a></h3>
<p>In order to dynamically generates X509 certificates, the Elassandra-Operator use a root CA certificate and private key stored as
Kubernetes secrets. If theses CA secrets does not exist in the namespace where the datacenter is deployed, the operator automatically generates
a self-signed root CA certificate in that namespace:</p>
<ul class="simple">
<li><p>Secret <strong>elassandra-{clusterName}-ca-pub</strong> contains the root CA certificate as a PEM file and PKCS12 keystore.</p></li>
<li><p>Secret <strong>elassandra-{clusterName}-ca-key</strong> contains the root CA private key in a PKCS12 keystore.</p></li>
</ul>
<p>Of course, multi-datacenter Elassandra cluster runing in different namespaces or different kubernetes clusters should share the same root CA.
You can easily copy CA secrets from one namespace (NS) to another namespace (NS2) like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>kubectl get secret elassandra-cl1-ca-pub --namespace=$NS --export -o yaml | kubectl apply --namespace=$NS2 -f - || true
kubectl get secret elassandra-cl1-ca-key --namespace=$NS --export -o yaml | kubectl apply --namespace=$NS2 -f - || true
</pre></div>
</div>
<p>To copy secrets from one kubernetes cluster to another one, you can probably use the
<a class="reference external" href="https://github.com/admiraltyio/multicluster-service-account">Multicluster-Service-Account</a> from <a class="reference external" href="https://admiralty.io/">Admiralty</a>.</p>
</div>
<div class="section" id="generated-certificates">
<h3>Generated Certificates<a class="headerlink" href="#generated-certificates" title="Permalink to this headline">¶</a></h3>
<p>When an Elassandra datacenter is deployed, a SSL/TLS keystore is generated from the namespaced root CA certificate if it does not exists in the secret
<code class="docutils literal notranslate"><span class="pre">elassandra-{clusterName}-{dcName}-keystore</span></code>. This certificate has a wildcard certificate subjectAltName extension matching all Elassandra datacenter pods.
It also have the localhost and 127.0.0.1 extensions to allow local connections.</p>
<p>This TLS certificates and keys are used to secure:</p>
<ul class="simple">
<li><p>Cassandra node-to-node and client-to-node connections.</p></li>
<li><p>Cassandra JMX connection for administration and monitoring.</p></li>
<li><p>Elasticsearch client request overs HTTPS and Elasticsearch inter-node transport connections.</p></li>
</ul>
<p>Alternatively, your may use the <a class="reference external" href="https://cert-manager.io/">cert-manager</a> to manage theses certificates in a Kubernetes secret having the same name and content.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In a multi-datacenter cluster, you don’t need to copy this secret to all datacenters.</p>
</div>
</div>
</div>
<div class="section" id="elassandra-credentials">
<h2>Elassandra Credentials<a class="headerlink" href="#elassandra-credentials" title="Permalink to this headline">¶</a></h2>
<p>Elassandra operator automatically create strong passwords in the <code class="docutils literal notranslate"><span class="pre">elassandra-{clusterName}</span></code> secret for the following account if they does not yet exists :</p>
<ul class="simple">
<li><p>Cassandra <strong>cassandra</strong> superuser.</p></li>
<li><p>Cassandra <strong>admin</strong> role with the cassandra superuser privilege.</p></li>
<li><p>Cassandra <strong>elassandra_operator</strong> role with no superuser privilege.</p></li>
<li><p>Cassandra JMX password</p></li>
<li><p>Cassandra reaper admin password.</p></li>
</ul>
<p>Here is such kubernetes secret for an Elassandra cluster named <strong>cl1</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">secret</span> <span class="o">-</span><span class="n">n</span> <span class="n">ns1</span> <span class="n">elassandra</span><span class="o">-</span><span class="n">cl1</span> <span class="o">-</span><span class="n">o</span> <span class="n">yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Secret</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">creationTimestamp</span><span class="p">:</span> <span class="s2">&quot;2020-06-08T13:15:55Z&quot;</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">elassandra</span>
    <span class="n">app</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">managed</span><span class="o">-</span><span class="n">by</span><span class="p">:</span> <span class="n">elassandra</span><span class="o">-</span><span class="n">operator</span>
    <span class="n">elassandra</span><span class="o">.</span><span class="n">strapdata</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">cluster</span><span class="p">:</span> <span class="n">cl1</span>
    <span class="n">elassandra</span><span class="o">.</span><span class="n">strapdata</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">credential</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">elassandra</span><span class="o">-</span><span class="n">cl1</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">ns4</span>
  <span class="n">ownerReferences</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">apiVersion</span><span class="p">:</span> <span class="n">elassandra</span><span class="o">.</span><span class="n">strapdata</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">v1</span>
    <span class="n">blockOwnerDeletion</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">controller</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">kind</span><span class="p">:</span> <span class="n">ElassandraDatacenter</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">elassandra</span><span class="o">-</span><span class="n">cl1</span><span class="o">-</span><span class="n">dc1</span>
    <span class="n">uid</span><span class="p">:</span> <span class="mi">497</span><span class="n">b922d</span><span class="o">-</span><span class="mi">874</span><span class="n">c</span><span class="o">-</span><span class="mi">4</span><span class="n">f2d</span><span class="o">-</span><span class="n">bf05</span><span class="o">-</span><span class="n">a31a3f4682de</span>
  <span class="n">resourceVersion</span><span class="p">:</span> <span class="s2">&quot;131584&quot;</span>
  <span class="n">selfLink</span><span class="p">:</span> <span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">namespaces</span><span class="o">/</span><span class="n">ns4</span><span class="o">/</span><span class="n">secrets</span><span class="o">/</span><span class="n">elassandra</span><span class="o">-</span><span class="n">cl1</span>
  <span class="n">uid</span><span class="p">:</span> <span class="mi">8</span><span class="n">b27562c</span><span class="o">-</span><span class="mi">54</span><span class="n">c3</span><span class="o">-</span><span class="mi">48</span><span class="n">fb</span><span class="o">-</span><span class="mi">8</span><span class="n">bfd</span><span class="o">-</span><span class="mi">91</span><span class="n">ab253da775</span>
<span class="nb">type</span><span class="p">:</span> <span class="n">Opaque</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">cassandra</span><span class="o">.</span><span class="n">admin_password</span><span class="p">:</span> <span class="n">MmY5N2IzYWUtNWYyYy00MGI0LTgwMmEtYjIzOTZlOGU2Yzhi</span>
  <span class="n">cassandra</span><span class="o">.</span><span class="n">cassandra_password</span><span class="p">:</span> <span class="n">MzM5MTVhOTYtNTQyMC00ZmI0LTlkMjctMDE2Y2VhNmNmZDM0</span>
  <span class="n">cassandra</span><span class="o">.</span><span class="n">elassandra_operator_password</span><span class="p">:</span> <span class="n">ZmQ2NTI5NGQtZTI1ZS00MzFhLWFkZTctYzE2ZjQwOGY5ZDU0</span>
  <span class="n">cassandra</span><span class="o">.</span><span class="n">jmx_password</span><span class="p">:</span> <span class="n">NzRmYzUxM2YtYjkzNi00NzU2LWE3ZTEtNmVjMGM4Y2NlMTc4</span>
  <span class="n">cassandra</span><span class="o">.</span><span class="n">reaper_password</span><span class="p">:</span> <span class="n">YWM0ZmM2ZGMtZWI5OC00ZWQxLWI1NTUtYjg1NjEyYTMwZGJl</span>
  <span class="n">shared</span><span class="o">-</span><span class="n">secret</span><span class="o">.</span><span class="n">yaml</span><span class="p">:</span> <span class="n">YWFhLnNoYXJlZF9zZWNyZXQ6IDE0MjY0YjI4LWQ0ZTAtNGFkMC05MDUzLWE0NjUwMzk2MDI3Mg</span><span class="o">==</span>
</pre></div>
</div>
<p>Like for certificates, in a multi-datacenter Elassandra cluster deployed in different namespaces or different Kubernetes clusters,
you must copy this secret to all Elassandra datacenters.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="operations.html" class="btn btn-neutral float-right" title="Operations" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="advanced-services.html" class="btn btn-neutral float-left" title="Advanced services" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Strapdata

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>